# 04 - Python 文件操作

## 1. 打开文件的模式

使用 `open` 打开文件时，需要指定模式。可用的模式有：

| 模式  | 描述                                                                                                                                                               |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|  `t`  | 文本模式 (默认)。                                                                                                                                                  |
|  `x`  | 写模式，新建一个文件，如果该文件已存在则会报错。                                                                                                                   |
|  `b`  | 二进制模式。                                                                                                                                                       |
|  `+`  | 打开一个文件进行更新(可读可写)。                                                                                                                                   |
|  `U`  | 通用换行模式（不推荐）。                                                                                                                                           |
|  `r`  | 以只读方式打开文件。文件的指针将会放在文件的开头。这是默认模式。                                                                                                   |
| `rb`  | 以二进制格式打开一个文件用于只读。文件指针将会放在文件的开头。这是默认模式。一般用于非文本文件如图片等。                                                           |
| `r+`  | 打开一个文件用于读写。文件指针将会放在文件的开头。                                                                                                                 |
| `rb+` | 以二进制格式打开一个文件用于读写。文件指针将会放在文件的开头。一般用于非文本文件如图片等。                                                                         |
|  `w`  | 打开一个文件只用于写入。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。                                           |
| `wb`  | 以二进制格式打开一个文件只用于写入。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。一般用于非文本文件如图片等。   |
| `w+`  | 打开一个文件用于读写。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。                                             |
| `wb+` | 以二进制格式打开一个文件用于读写。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。一般用于非文本文件如图片等。     |
|  `a`  | 打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。也就是说，新的内容将会被写入到已有内容之后。如果该文件不存在，创建新文件进行写入。             |
| `ab`  | 以二进制格式打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。也就是说，新的内容将会被写入到已有内容之后。如果该文件不存在，创建新文件进行写入。 |
| `a+`  | 打开一个文件用于读写。如果该文件已存在，文件指针将会放在文件的结尾。文件打开时会是追加模式。如果该文件不存在，创建新文件用于读写。                                 |
| `ab+` | 以二进制格式打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。如果该文件不存在，创建新文件用于读写。                                             |

## 2. 逐行读文件

```python
with open("./test.txt", "r") as f:
    for line in f:
        if not line.rstrip():
            continue
        print("line: {%s}" % line.rstrip())
```

**上面的示例在 Python 2.6 及以上版本都可以运行。Python 2.5 以下版本不支持 `with` 语句。**

## 3. 写文件

为了保证文件的完整性，可以先写入临时文件，写入完成后再重命名。示例如下：

```python
import os
import shutil

filename = "./test.txt"
tmp_filename = "%s_tmp" % filename

# 如果临时文件已经存在，先删除
if os.path.isfile(tmp_filename):
    os.remove(tmp_filename)

with open(tmp_filename, "w") as f:
    f.write("line 1\n")
    f.write("line 2\n")

# 使用临时文件覆盖目标文件
shutil.move(tmp_filename, filename)
```

注意，最后的重命名操作使用 `os.rename(tmp_filename, filename)` 也可以实现，但是当源文件和目标文件不在同一个分区、驱动器、设备上时不能完成重命名。

**上面的示例在 Python 2.6 及以上版本都可以运行。Python 2.5 以下版本不支持 `with` 语句。**
